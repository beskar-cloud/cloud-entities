# cloud-entities

GitOps beskar cloud entities declaratively stored for terraform and ansible deployment.

Deploy is done in two separated steps:
1. using terraform (sync objects in cloud)
2. using ansible roles (add / change only for objects prepared for cloud users and/or project hierarchy propagation actions)
on every repository change AND also periodically via scheduled pipeline.


## openstack entities

Repository uses mostly direct terraform HCL syntax (`*.tf`) with exceptions for:
 * project-quota-acl
 * static-identity-mapping
which are used as a source and *.tf files are generated by python generator[s] in [ci/src/*.py](/ci/src/)

The reasons why are above entities stored in non-HCL syntax are:
 * more convenient format, user/machine easily generated
 * support for automatic openstack project lifecycle management (so projects may get expired w/o touching got repository)

Terraform state is currently managed by Gitlab / Github / S3 storage.

This repository contains most important Openstack entities typically pre-created by cloud admin team like:
 * [domains](/environments/dev-beskar/openstack/domains)
 * [projects, quotas, ACLs](/environments/dev-beskar/openstack/projects-quotas-acls)
 * [system roles](/environments/dev-beskar/openstack/roles)
 * [ad-hoc users](/environments/dev-beskar/openstack/users) and their [role assignments](/environments/dev-beskar/openstack/role-assignments)
 * [identity mappings](/environments/dev-beskar/openstack/global-static-identity-mappings)
 * [flavors](/environments/dev-beskar/openstack/flavors)
 * [networks](/environments/dev-beskar/openstack/networks)
 * [subnets](/environments/dev-beskar/openstack/subnets)
 * [routers](/environments/dev-beskar/openstack/routers)
 * [host aggregates](/environments/dev-beskar/openstack/aggregates)
 * project reserved [floating ips](/environments/dev-beskar/openstack/floating-ips)

Following entities are typically NOT included by purpose:
 * any user related entities
 * personal projects
 * auto-generated users (AAI data)

There may be exceptions, for instance when we want to disable personal project we can list it as disabled.

## Grafana monitoring UI entities

We maintain here only basic entities as:
 * data sources
 * folders
 * teams
 * users with higher role (not functional yet)

Following entities are typically NOT included by purpose:
 * dashboards (as we want to support in UI modification, revert to previous version will be possible via MariaDB revert or via import from a cloud-entities-dump repository.

## FAQ

### Missing functionality

1. Grafana entities are not yet pushed from CI/CD pipeline.

### How to import existing cloud object[s] into terraform state with CI/CD pipeline

Run manual pipeline with environment variable `TERRAFORM_IMPORT_ARGS`. If you need multiple imports at once you may use also variables `TERRAFORM_IMPORT1_ARGS` ... `TERRAFORM_IMPORT10_ARGS`.

Example:

```sh
TERRAFORM_IMPORT_ARGS="openstack_identity_project_v3.einfra_cz_meta_cloud_kubernetes cb00fe018d2b494f86adb7ae80b7b545"
```

### How to manipulate with terraform state from your machine

You should generally avoid it, but in some situations it may be handy to perform multiple actions at once.
When absolutely necessary follow CI/CD pipeline steps (`before_script` and deploy snippet yaml anchored as `&deploy-workflow` ).

Terraform backend environment variables are dumped every CI pipeline job, rest of credentials are stored in CI-CD variables.

### How to include sensitive data into the *openstack-entities repository

1. Define variable (as sensitive = true). Name of the variable should contain full path i.e. `<resource-type>_<resource-name>_<resource-field-name>`
1. Assign entity field with the variable (`field = var.<name-of-var>`)
1. Define secret in protected CI/CD variable `OSTACK_TF_ENV_VARS_FILE` (type file) for OpenStack terraform part and `GRAFANA_TF_ENV_VARS_FILE` (type file) for Grafana terraform part


### How to disable project keeping resources

* drop openstack mapping
* add `.project.enabled=false`

### How to deal with pipeline unable to acquire terraform state lock - terraform stale locks

If you encounter situation when Gitlab Terraform HTTP backend lock gets stale i.e.
```console
...
INFO: Performing step plan (terraform plan --out=deploy.tfplan, log:20231013T101001-terraform-plan.log)
╷
│ Error: Error acquiring the state lock
│ 
│ Error message: HTTP remote state already locked:
│ ID=f2b030b0-8d74-afc4-9f7b-421e7fe5b7f0
│ Lock Info:
│   ID:        b83b38f5-2628-074a-b4af-dda1632af3f3
│   Path:      
│   Operation: OperationTypePlan
│   Who:       root@runner-ff44bedb-project-5290-concurrent-1
│   Version:   1.5.2
│   Created:   2023-10-13 10:10:01.353769935 +0000 UTC
│   Info:      
│ 
│ ...
```

You should launch manual CI pipeline job `ostack-entities-deploy-manual` with following environment configuration:
```
WORKFLOW_STEPS_DEPLOY_MANUAL="init,version,validate,providers,graph,state-list-if-exists,force-unlock"
TERRAFORM_LOCK_ID="f2b030b0-8d74-afc4-9f7b-421e7fe5b7f0"
```
Next CI pipeline should work as expected.

### How apply Terraform antities into empty OpenStack cloud

Assume you have entered situation when OpenStack DB is lost.

In such situation you will encounter cloud-entities pipeline:
 * conflicts on default openstack roles
 * conflicts on default (and einfra_cz) openstack domains
 * conflicts on default/admin openstack project

To solve this situation you should:
 * Save current state from Gitlab state-page
 * Verify state is properly stored and is not empty
 * Delete terraform cloud state (for instance `dev-beskar`)
 * Launch manual job `ostack-entities-deploy-manual` with following arguments:
   * domains
     * `TERRAFORM_IMPORT1_ARGS = openstack_identity_project_v3.Default default`
     * `TERRAFORM_IMPORT2_ARGS = openstack_identity_project_v3.einfra_cz 3******************************5`
   * default/admin project
     * `TERRAFORM_IMPORT3_ARGS = openstack_identity_project_v3.Default_admin 2******************************0`
   * optionally various default roles, these should addressed already:
     * `TERRAFORM_IMPORT4_ARGS = openstack_identity_role_v3.heat_stack_user 8******************************8`
     * `TERRAFORM_IMPORT5_ARGS = openstack_identity_role_v3.member 5******************************0`
     * `TERRAFORM_IMPORT6_ARGS = openstack_identity_role_v3.reader 4******************************9`
     * `TERRAFORM_IMPORT7_ARGS = openstack_identity_role_v3.admin c******************************1`

To see actual ids, you need to perform following commands as openstack system admin:
```
openstack domain list
openstack project list
openstack role list
```
